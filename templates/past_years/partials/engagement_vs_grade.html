{% load i18n %}

<!-- Start Engagement vs Grade Analysis Section -->
<div class="col-span-full">
    <div class="card">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <div>
                    <h5 class="card-title">{% trans "Engagement vs Grade Performance" %}</h5>
                    <p class="text-gray-500 dark:text-dark-text-two">{% trans "Compare average grade scores between high engagement students (top 25%) vs low engagement students (bottom 25%) by academic year" %}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Engagement Metric Toggle -->
                    <div class="flex bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                        <button id="activitiesHoursToggle" class="px-3 py-2 text-xs font-semibold rounded-l-lg transition-all duration-200 bg-primary-500 hover:bg-primary-700 text-white shadow-md border-r border-gray-300 dark:border-gray-600">
                            <i class="ri-bar-chart-grouped-line mr-1"></i>
                            {% trans "Activities × Hours" %}
                        </button>
                        <button id="activitiesToggle" class="px-3 py-2 text-xs font-semibold transition-all duration-200 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500 border-r border-gray-300 dark:border-gray-600">
                            <i class="ri-bar-chart-line mr-1"></i>
                            {% trans "Activities" %}
                        </button>
                        <button id="hoursToggle" class="px-3 py-2 text-xs font-semibold rounded-r-lg transition-all duration-200 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-500">
                            <i class="ri-time-line mr-1"></i>
                            {% trans "Hours" %}
                        </button>
                    </div>

                    <!-- Refresh Button -->
                    <button id="refreshEngagementVsGradeBtn" class="px-4 py-2 text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i class="ri-refresh-line mr-2"></i>
                        {% trans "Refresh" %}
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Chart Container -->
            <div class="h-auto w-full">
                <div id="engagementVsGradeChart">
                    <!-- Loading state will be replaced by chart -->
                    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                        <i class="ri-loader-4-line text-4xl animate-spin mb-4"></i>
                        <p class="text-lg font-medium mb-2">{% trans "Loading Engagement vs Grade Analysis..." %}</p>
                        <p class="text-sm">{% trans "Calculating engagement scores and comparing with grade performance" %}</p>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="mt-6 grid grid-cols-12 gap-4">
                <!-- High Engagement Average Card -->
                <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="ri-trophy-line text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-green-900 dark:text-green-100">{% trans "High Engagement Avg" %}</p>
                                <p class="text-lg font-semibold text-green-900 dark:text-green-100" id="highEngagementAvg">
                                    -
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Low Engagement Average Card -->
                <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                    <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center">
                                    <i class="ri-user-line text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-orange-900 dark:text-orange-100">{% trans "Low Engagement Avg" %}</p>
                                <p class="text-lg font-semibold text-orange-900 dark:text-orange-100" id="lowEngagementAvg">
                                    -
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Gap Card -->
                <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="ri-bar-chart-line text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-blue-900 dark:text-blue-100">{% trans "Performance Gap" %}</p>
                                <p class="text-lg font-semibold text-blue-900 dark:text-blue-100" id="performanceGap">
                                    -
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Years Analyzed Card -->
                <div class="col-span-12 sm:col-span-6 lg:col-span-3">
                    <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i class="ri-calendar-check-line text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-purple-900 dark:text-purple-100">{% trans "Years Analyzed" %}</p>
                                <p class="text-lg font-semibold text-purple-900 dark:text-purple-100" id="yearsAnalyzedEngagement">
                                    -
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Methodology (Collapsible) -->
            <div class="mt-6 border-t border-gray-200 dark:border-gray-600 pt-4">
                <div class="mb-3 bg-gray-200 dark:bg-gray-800 rounded-lg p-3">
                    <button id="toggleEngagementVsGradeExplanation" class="flex items-center space-x-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors cursor-pointer">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>{% trans "How is this calculated?" %}</span>
                        <svg id="engagementVsGradeExplanationToggleIcon" class="w-3 h-3 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>

                <!-- Explanation Content (Initially Hidden) -->
                <div id="engagementVsGradeExplanationContent" class="hidden space-y-4">
                    <!-- Engagement Calculation -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h4a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 00-2-2z"></path>
                            </svg>
                            {% trans "Engagement Score Calculation" %}
                        </h4>
                        <div class="space-y-3 text-sm text-blue-700 dark:text-blue-300">
                            <div class="grid grid-cols-12 gap-4">
                                <div class="col-span-12 sm:col-span-6 lg:col-span-6">
                                    <h5 class="font-medium mb-2">{% trans "Engagement Formula:" %}</h5>
                                    <div class="bg-white dark:bg-gray-800 rounded p-3 text-xs font-mono">
                                        <div class="text-blue-600 dark:text-blue-400 mb-2"><strong>{% trans "Engagement Score =" %}</strong></div>
                                        <div>{% trans "Total Activities × Total Hours" %}</div>
                                        <div class="mt-2 text-gray-600 dark:text-gray-400">
                                            <div>{% trans "Where:" %}</div>
                                            <div>• {% trans "Activities = Count of platform interactions" %}</div>
                                            <div>• {% trans "Hours = Time spent on platform" %}</div>
                                            <div>• {% trans "Session capping: 30 min max per activity" %}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-span-12 sm:col-span-6 lg:col-span-6">
                                    <h5 class="font-medium mb-2">{% trans "Example Calculation:" %}</h5>
                                    <div class="bg-white dark:bg-gray-800 rounded p-3 text-xs">
                                        <div class="mb-2"><strong>{% trans "Student A (High Engagement):" %}</strong></div>
                                        <div>{% trans "Activities: 450 interactions" %}</div>
                                        <div>{% trans "Hours: 125.5 hours" %}</div>
                                        <div class="text-blue-600 dark:text-blue-400 mt-1">{% trans "Score: 450 × 125.5 = 56,475" %}</div>
                                        <div class="mt-3"><strong>{% trans "Student B (Low Engagement):" %}</strong></div>
                                        <div>{% trans "Activities: 85 interactions" %}</div>
                                        <div>{% trans "Hours: 23.2 hours" %}</div>
                                        <div class="text-orange-600 dark:text-orange-400 mt-1">{% trans "Score: 85 × 23.2 = 1,972" %}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Method -->
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 dark:text-green-200 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            {% trans "Comparative Analysis Method" %}
                        </h4>
                        <div class="space-y-3 text-sm text-green-700 dark:text-green-300">
                            <div class="grid grid-cols-12 gap-4">
                                <div class="col-span-12 sm:col-span-6 lg:col-span-6">
                                    <h5 class="font-medium mb-2">{% trans "Student Categorization:" %}</h5>
                                    <ul class="space-y-1 text-xs">
                                        <li>• {% trans "All students with both engagement data (ClickHouse) and grade data (Analysis DB) are ranked by engagement score" %}</li>
                                        <li>• {% trans "Top 25% = High engagement students (highest quarter)" %}</li>
                                        <li>• {% trans "Bottom 25% = Low engagement students (lowest quarter)" %}</li>
                                        <li>• {% trans "Academic year determined by course name pattern (e.g., '2024年度')" %}</li>
                                        <li>• {% trans "Minimum thresholds: 5+ activities, 3+ grades, 10+ total students" %}</li>
                                    </ul>
                                </div>
                                <div class="col-span-12 sm:col-span-6 lg:col-span-6">
                                    <h5 class="font-medium mb-2">{% trans "Database Integration:" %}</h5>
                                    <div class="bg-white dark:bg-gray-800 rounded p-3 text-xs">
                                        <div class="mb-2"><strong>{% trans "ClickHouse (Engagement):" %}</strong></div>
                                        <div>{% trans "• Pre-2025 & 2025+ databases" %}</div>
                                        <div>{% trans "• Activity logs with time tracking" %}</div>
                                        <div>{% trans "• Student ID matching via UserMatch" %}</div>
                                        <div class="mt-2"><strong>{% trans "Analysis DB (Grades):" %}</strong></div>
                                        <div>{% trans "• Course assessment results" %}</div>
                                        <div>{% trans "• Academic year-specific filtering" %}</div>
                                        <div>{% trans "• Valid grade records (0-100 scale)" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-green-100 dark:bg-green-800/30 rounded p-3">
                                <strong>{% trans "Key Insight:" %}</strong> {% trans "This analysis reveals whether students who spend more time and have more interactions on the platform (high engagement) actually achieve better academic outcomes compared to students with minimal platform usage (low engagement). The chart shows grade performance differences across academic years." %}
                            </div>
                        </div>
                    </div>

                    <!-- Data Quality & Limitations -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            {% trans "Data Quality & Considerations" %}
                        </h4>
                        <div class="text-xs text-gray-600 dark:text-gray-400 space-y-2">
                            <div class="grid grid-cols-12 gap-4">
                                <div class="col-span-12 sm:col-span-6 lg:col-span-6">
                                    <strong>{% trans "Quality Controls:" %}</strong>
                                    <ul class="mt-1 space-y-1">
                                        <li>• {% trans "Session capping prevents unrealistic time calculations" %}</li>
                                        <li>• {% trans "Minimum activity thresholds ensure meaningful data" %}</li>
                                        <li>• {% trans "Course-based academic year matching for accuracy" %}</li>
                                        <li>• {% trans "Student ID validation across multiple databases" %}</li>
                                    </ul>
                                </div>
                                <div class="col-span-12 sm:col-span-6 lg:col-span-6">
                                    <strong>{% trans "Limitations:" %}</strong>
                                    <ul class="mt-1 space-y-1">
                                        <li>• {% trans "Platform usage may not reflect all learning activities" %}</li>
                                        <li>• {% trans "Grade data limited to available course assessments" %}</li>
                                        <li>• {% trans "Correlation does not imply causation" %}</li>
                                        <li>• {% trans "External factors (study habits, support) not measured" %}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Engagement vs Grade Analysis Section -->