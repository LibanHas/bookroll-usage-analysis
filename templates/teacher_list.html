{% extends 'main.html' %}
{% load static %}
{% load i18n %}
{% block main_content %}

<div class="grid grid-cols-12 gap-x-4">
    <!-- Start Bread Crumb Section -->
    <div class="col-span-full card flex-center-between">
        <div>
            <h5 class="card-title">{% trans "Teacher list" %}</h5>
            <ul class="flex items-center flex-wrap gap-1.5 *:flex-center *:gap-1.5 leading-none text-gray-900 dark:text-dark-text mt-2">
                {% for breadcrumb in breadcrumbs %}
                <li class="text-primary-500 after:font-remix after:flex-center after:font-thin after:text-gray-900 after:size-5 after:content-['\ea6d'] after:translate-y-[1.4px] last:after:hidden {% if not breadcrumb.url %}current-page text-gray-500 dark:text-dark-text-two{% endif %}">
                    {% if breadcrumb.url %}
                    <a href="{% url breadcrumb.url %}">{{ breadcrumb.name }}</a>
                    {% else %}
                    <span>{{ breadcrumb.name }}</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        <!-- Cache Controls -->
        <div class="flex items-center gap-2">
            <form method="POST" action="{% url 'teacher_clear_cache' %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-secondary-solid btn-sm flex items-center gap-2 hover:bg-secondary-600 transition-colors duration-200" title="{% trans 'Clear Cache' %}">
                    <i class="ri-refresh-line mr-1 text-white"></i>
                    {% trans "Clear Cache" %}
                </button>
            </form>
        </div>
    </div>
    <!-- End Bread Crumb Section -->

    <!-- Start Teacher Activity Chart Section -->
    <div class="col-span-full mb-6">
        <div class="card">
            <div class="flex flex-col gap-4 sm:flex-center-between sm:flex-row p-6 border-b border-gray-200 dark:border-dark-border">
                <div>
                    <h6 class="card-title text-lg font-semibold">{% trans "Most Active Teachers" %}</h6>
                    <p class="card-description text-sm text-gray-600 dark:text-gray-400">{% trans "Teacher activity statistics" %}</p>
                </div>
                <!-- Time Filter Dropdown -->
                <div class="flex items-center gap-3">
                    <label for="chartTimeFilter" class="text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Time Period:" %}</label>
                    <div class="relative inline-block flex items-center border border-gray-200 rounded-md">
                        <select id="chartTimeFilter" name="chart_filter" class="form-select pr-8 min-w-48" onchange="updateChart()">
                            {% for option in time_filter_options %}
                                <option value="{{ option.value }}" {% if option.value == chart_time_filter %}selected{% endif %}>
                                    {{ option.label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <i class="ri-arrow-down-s-line text-gray-500 dark:text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6">
                <div id="teacherActivityChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    <!-- End Teacher Activity Chart Section -->

    <!-- Start Teacher List Section -->
    <div class="col-span-full">
        <div class="card p-0 lg:min-h-[calc(100vh_-_theme('spacing.header')_*_1.4)] xl:min-h-[calc(100vh_-_theme('spacing.header')_*_1.6)]">
            <div class="flex flex-col gap-2 sm:flex-center-between sm:flex-row px-4 py-5 sm:p-7 bg-gray-200/30 dark:bg-dark-card-shade">
                <div>
                    <h6 class="card-title">{% trans "Teacher list" %}</h6>
                    <p class="card-description">{% trans "All Teacher Here" %}</p>
                </div>
                <!-- Search Form -->
                <form method="GET" class="flex items-center gap-2">
                    <input
                        type="text"
                        name="search"
                        placeholder="{% trans 'Search...' %}"
                        value="{{ search_term }}"
                        class="form-input"
                    />
                    <!-- Preserve sort parameters in search -->
                    {% if current_sort_by %}
                        <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
                    {% endif %}
                    {% if current_sort_order %}
                        <input type="hidden" name="sort_order" value="{{ current_sort_order }}">
                    {% endif %}
                    <button type="submit" class="btn b-solid btn-primary-solid">
                        {% trans "Search" %}
                    </button>
                </form>
            </div>
            <!-- Start All Instructor List Table -->
            <div class="p-3 sm:p-4">
                <div class="overflow-x-auto scrollbar-table">
                    {% if teachers %}
                    <table class="table-auto border-collapse w-full whitespace-nowrap text-left text-gray-500 dark:text-dark-text font-medium">
                        <thead>
                            <tr class="text-primary-500">
                                <th class="px-4 py-4 bg-[#F2F4F9] dark:bg-dark-card-two first:rounded-l-lg last:rounded-r-lg dk-theme-card-square">
                                    <div class="flex items-center gap-2">
                                        <span>{% trans "Name" %}</span>
                                        <div class="flex flex-col">
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=name&sort_order=asc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'name' and current_sort_order == 'asc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-up-s-line text-xs"></i>
                                            </a>
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=name&sort_order=desc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'name' and current_sort_order == 'desc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-down-s-line text-xs"></i>
                                            </a>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-4 py-4 bg-[#F2F4F9] dark:bg-dark-card-two first:rounded-l-lg last:rounded-r-lg dk-theme-card-square">
                                    <div class="flex items-center gap-2">
                                        <span>{% trans "Active Courses" %}</span>
                                        <div class="flex flex-col">
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=active_courses&sort_order=asc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'active_courses' and current_sort_order == 'asc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-up-s-line text-xs"></i>
                                            </a>
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=active_courses&sort_order=desc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'active_courses' and current_sort_order == 'desc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-down-s-line text-xs"></i>
                                            </a>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-4 py-4 bg-[#F2F4F9] dark:bg-dark-card-two first:rounded-l-lg last:rounded-r-lg dk-theme-card-square">
                                    <div class="flex items-center gap-2">
                                        <span>{% trans "Archived Courses" %}</span>
                                        <div class="flex flex-col">
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=archived_courses&sort_order=asc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'archived_courses' and current_sort_order == 'asc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-up-s-line text-xs"></i>
                                            </a>
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=archived_courses&sort_order=desc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'archived_courses' and current_sort_order == 'desc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-down-s-line text-xs"></i>
                                            </a>
                                        </div>
                                    </div>
                                </th>
                                <th class="px-4 py-4 bg-[#F2F4F9] dark:bg-dark-card-two first:rounded-l-lg last:rounded-r-lg dk-theme-card-square">
                                    <div class="flex items-center gap-2">
                                        <span>{% trans "Total Course" %}</span>
                                        <div class="flex flex-col">
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=total_courses&sort_order=asc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'total_courses' and current_sort_order == 'asc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-up-s-line text-xs"></i>
                                            </a>
                                            <a href="?{% if search_term %}search={{ search_term }}&{% endif %}sort_by=total_courses&sort_order=desc"
                                               class="text-gray-400 hover:text-primary-500 {% if current_sort_by == 'total_courses' and current_sort_order == 'desc' %}text-primary-500{% endif %}">
                                                <i class="ri-arrow-down-s-line text-xs"></i>
                                            </a>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-dark-border">
                            {% for teacher in teachers %}
                            <tr>
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-3.5">
                                        <a href="#" class="size-12 rounded-50 overflow-hidden dk-theme-card-square">
                                            <img src="{% static 'images/profile/profile.png' %}" alt="{% trans 'instructor' %}">
                                        </a>
                                        <div>
                                            <h6 class="leading-none text-heading font-semibold">
                                                <a href="{% url 'teacher_detail' teacher.user_id %}">{{ teacher.firstname }} {{ teacher.lastname }}</a>
                                            </h6>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-4">{{ teacher.active_courses }}</td>
                                <td class="px-4 py-4">{{ teacher.archived_courses }}</td>
                                <td class="px-4 py-4">{{ teacher.total_courses }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    {% if is_paginated %}
                    <div class="flex justify-center items-center mt-6">
                        <nav class="pagination-nav">
                            <ul class="flex items-center space-x-2">
                                {% if page_obj.has_previous %}
                                    <li>
                                        <a href="?page={{ page_obj.previous_page_number }}{% if search_term %}&search={{ search_term }}{% endif %}{% if current_sort_by %}&sort_by={{ current_sort_by }}{% endif %}{% if current_sort_order %}&sort_order={{ current_sort_order }}{% endif %}" class="flex items-center justify-center w-10 h-10 text-gray-600 bg-white rounded-md hover:bg-primary-100 hover:text-primary-600 dark:bg-dark-card-two dark:text-dark-text dark:hover:bg-primary-900 dark:hover:text-primary-400">
                                            <span class="sr-only">{% trans "Previous" %}</span>
                                            <i class="fas fa-angle-left">&lt;</i>
                                        </a>
                                    </li>
                                {% else %}
                                    <li>
                                        <span class="flex items-center justify-center w-10 h-10 text-gray-400 bg-white rounded-md cursor-not-allowed dark:bg-dark-card-two dark:text-gray-600">
                                            <i class="fas fa-angle-left">&lt;</i>
                                        </span>
                                    </li>
                                {% endif %}

                                {% if page_obj.paginator.num_pages < 10 %}
                                    <!-- Show all pages if total pages < 10 -->
                                    {% for num in page_obj.paginator.page_range %}
                                        <li>
                                            {% if num == page_obj.number %}
                                                <span class="flex items-center justify-center w-10 h-10 text-white bg-primary-500 rounded-md">{{ num }}</span>
                                            {% else %}
                                                <a href="?page={{ num }}{% if search_term %}&search={{ search_term }}{% endif %}{% if current_sort_by %}&sort_by={{ current_sort_by }}{% endif %}{% if current_sort_order %}&sort_order={{ current_sort_order }}{% endif %}" class="flex items-center justify-center w-10 h-10 text-gray-600 bg-white rounded-md hover:bg-primary-100 hover:text-primary-600 dark:bg-dark-card-two dark:text-dark-text dark:hover:bg-primary-900 dark:hover:text-primary-400">{{ num }}</a>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                {% else %}
                                    <!-- Show first 2 pages, ellipsis, and last 2 pages -->

                                    <!-- First 2 pages -->
                                    {% for num in "12"|make_list %}
                                        {% with num=num|add:"0" %}
                                        <li>
                                            {% if num|add:0 == page_obj.number %}
                                                <span class="flex items-center justify-center w-10 h-10 text-white bg-primary-500 rounded-md">{{ num }}</span>
                                            {% else %}
                                                <a href="?page={{ num }}{% if search_term %}&search={{ search_term }}{% endif %}{% if current_sort_by %}&sort_by={{ current_sort_by }}{% endif %}{% if current_sort_order %}&sort_order={{ current_sort_order }}{% endif %}" class="flex items-center justify-center w-10 h-10 text-gray-600 bg-white rounded-md hover:bg-primary-100 hover:text-primary-600 dark:bg-dark-card-two dark:text-dark-text dark:hover:bg-primary-900 dark:hover:text-primary-400">{{ num }}</a>
                                            {% endif %}
                                        </li>
                                        {% endwith %}
                                    {% endfor %}

                                    <!-- Current page if not in first 2 or last 2 -->
                                    {% if page_obj.number > 2 and page_obj.number < page_obj.paginator.num_pages|add:"-1" %}
                                        <!-- Ellipsis before current if not right after first 2 -->
                                        {% if page_obj.number > 3 %}
                                            <li>
                                                <span class="flex items-center justify-center w-10 h-10 text-gray-600">...</span>
                                            </li>
                                        {% endif %}

                                        <!-- Current page -->
                                        <li>
                                            <span class="flex items-center justify-center w-10 h-10 text-white bg-primary-500 rounded-md">{{ page_obj.number }}</span>
                                        </li>

                                        <!-- Ellipsis after current if not right before last 2 -->
                                        {% if page_obj.number < page_obj.paginator.num_pages|add:"-2" %}
                                            <li>
                                                <span class="flex items-center justify-center w-10 h-10 text-gray-600">...</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <!-- Just show ellipsis between first 2 and last 2 -->
                                        <li>
                                            <span class="flex items-center justify-center w-10 h-10 text-gray-600">...</span>
                                        </li>
                                    {% endif %}

                                    <!-- Last 2 pages -->
                                    {% with second_last=page_obj.paginator.num_pages|add:"-1" %}
                                        {% for num in "12"|make_list %}
                                            {% if forloop.first %}
                                                <!-- Second to last page -->
                                                <li>
                                                    {% if second_last == page_obj.number %}
                                                        <span class="flex items-center justify-center w-10 h-10 text-white bg-primary-500 rounded-md">{{ second_last }}</span>
                                                    {% else %}
                                                        <a href="?page={{ second_last }}{% if search_term %}&search={{ search_term }}{% endif %}{% if current_sort_by %}&sort_by={{ current_sort_by }}{% endif %}{% if current_sort_order %}&sort_order={{ current_sort_order }}{% endif %}" class="flex items-center justify-center w-10 h-10 text-gray-600 bg-white rounded-md hover:bg-primary-100 hover:text-primary-600 dark:bg-dark-card-two dark:text-dark-text dark:hover:bg-primary-900 dark:hover:text-primary-400">{{ second_last }}</a>
                                                    {% endif %}
                                                </li>
                                            {% else %}
                                                <!-- Last page -->
                                                <li>
                                                    {% if page_obj.paginator.num_pages == page_obj.number %}
                                                        <span class="flex items-center justify-center w-10 h-10 text-white bg-primary-500 rounded-md">{{ page_obj.paginator.num_pages }}</span>
                                                    {% else %}
                                                        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_term %}&search={{ search_term }}{% endif %}{% if current_sort_by %}&sort_by={{ current_sort_by }}{% endif %}{% if current_sort_order %}&sort_order={{ current_sort_order }}{% endif %}" class="flex items-center justify-center w-10 h-10 text-gray-600 bg-white rounded-md hover:bg-primary-100 hover:text-primary-600 dark:bg-dark-card-two dark:text-dark-text dark:hover:bg-primary-900 dark:hover:text-primary-400">{{ page_obj.paginator.num_pages }}</a>
                                                    {% endif %}
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                {% endif %}

                                {% if page_obj.has_next %}
                                    <li>
                                        <a href="?page={{ page_obj.next_page_number }}{% if search_term %}&search={{ search_term }}{% endif %}{% if current_sort_by %}&sort_by={{ current_sort_by }}{% endif %}{% if current_sort_order %}&sort_order={{ current_sort_order }}{% endif %}" class="flex items-center justify-center w-10 h-10 text-gray-600 bg-white rounded-md hover:bg-primary-100 hover:text-primary-600 dark:bg-dark-card-two dark:text-dark-text dark:hover:bg-primary-900 dark:hover:text-primary-400">
                                            <span class="sr-only">{% trans "Next" %}</span>
                                            <i class="fas fa-angle-right">&gt;</i>
                                        </a>
                                    </li>
                                {% else %}
                                    <li>
                                        <span class="flex items-center justify-center w-10 h-10 text-gray-400 bg-white rounded-md cursor-not-allowed dark:bg-dark-card-two dark:text-gray-600">
                                            <i class="fas fa-angle-right">&gt;</i>
                                        </span>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                    <!-- End Pagination -->

                    {% else %}
                        <p>{% trans "No teachers found" %}</p>
                    {% endif %}
                </div>
            </div>
            <!-- End All Instructor List Table -->
        </div>
    </div>
    <!-- End Teacher List Section -->
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart data from Django context
    const chartSeries = {{ chart_series|safe }};
    const chartCategories = {{ chart_categories|safe }};
    const maxValue = {{ chart_max_value }};
    const topOperations = {{ top_operations|safe }};

    // Define colors for different operations
    const operationColors = [
        '#3B82F6', // Blue
        '#10B981', // Green
        '#F59E0B', // Amber
        '#EF4444', // Red
        '#8B5CF6', // Purple
        '#EC4899', // Pink
        '#14B8A6', // Teal
        '#F97316', // Orange
        '#84CC16', // Lime
        '#6366F1', // Indigo
        '#6B7280'  // Gray for "Other"
    ];

    // Chart options for stacked bar chart
    const options = {
        series: chartSeries,
        chart: {
            type: 'bar',
            height: 400,
            stacked: true,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '65%',
                borderRadius: 2
            }
        },
        dataLabels: {
            enabled: false  // Disable data labels for cleaner stacked view
        },
        stroke: {
            show: true,
            width: 1,
            colors: ['#fff']
        },
        xaxis: {
            categories: chartCategories,
            labels: {
                rotate: -45,
                style: {
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            title: {
                text: '{% trans "Activity Count" %}'
            },
            max: Math.max(maxValue * 1.1, 10)
        },
        colors: operationColors,
        fill: {
            opacity: 0.9
        },
        legend: {
            show: true,
            position: 'top',
            horizontalAlign: 'center',
            fontSize: '12px',
            markers: {
                width: 12,
                height: 12,
                radius: 2
            },
            itemMargin: {
                horizontal: 8,
                vertical: 2
            }
        },
        tooltip: {
            shared: true,
            intersect: false,
            y: {
                formatter: function (val, opts) {
                    const seriesName = opts.series[opts.seriesIndex][opts.dataPointIndex];
                    return val + ' {% trans "activities" %}';
                }
            },
            custom: function({series, seriesIndex, dataPointIndex, w}) {
                const teacherName = chartCategories[dataPointIndex];
                const operationName = w.globals.seriesNames[seriesIndex];
                const count = series[seriesIndex][dataPointIndex];
                const total = series.reduce((sum, s) => sum + (s[dataPointIndex] || 0), 0);

                return `
                    <div class="bg-white dark:bg-gray-800 p-3 border rounded shadow-lg">
                        <div class="font-semibold text-gray-900 dark:text-white mb-1">${teacherName}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300">
                            <div class="flex items-center mb-1">
                                <span class="w-3 h-3 rounded mr-2" style="background-color: ${w.globals.colors[seriesIndex]}"></span>
                                ${operationName}: ${count} {% trans "activities" %}
                            </div>
                            <div class="border-t pt-1 font-medium">
                                {% trans "Total" %}: ${total} {% trans "activities" %}
                            </div>
                        </div>
                    </div>
                `;
            }
        },
        grid: {
            borderColor: '#E5E7EB',
            strokeDashArray: 3
        },
        theme: {
            mode: document.documentElement.classList.contains('dark') ? 'dark' : 'light'
        }
    };

    // Render chart
    const chart = new ApexCharts(document.querySelector("#teacherActivityChart"), options);
    chart.render();

    // Store chart instance globally for updates
    window.teacherActivityChart = chart;
});

// Function to update chart when time filter changes
function updateChart() {
    const timeFilter = document.getElementById('chartTimeFilter').value;
    const currentUrl = new URL(window.location);

    // Preserve existing query parameters
    const searchParams = new URLSearchParams(currentUrl.search);
    searchParams.set('chart_filter', timeFilter);

    // Reload page with new filter
    window.location.href = currentUrl.pathname + '?' + searchParams.toString();
}

// Handle theme changes
function updateChartTheme() {
    if (window.teacherActivityChart) {
        const isDark = document.documentElement.classList.contains('dark');
        window.teacherActivityChart.updateOptions({
            theme: {
                mode: isDark ? 'dark' : 'light'
            }
        });
    }
}

// Listen for theme changes
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            updateChartTheme();
        }
    });
});

// Start observing theme changes
observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
});
</script>

{% endblock %}
